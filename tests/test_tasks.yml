---
# Tasks for testing role
- name: test tcpwrappers role
  hosts: all
  roles:
    - role: amtega.tcpwrappers

  vars:
    tcpwrappers_deny:
        ftpd:
          denied_service_name: "in.ftpd"
          denied_hosts_list:
            - ALL

    tcpwrappers_allow:
        ALL:
          allowed_service_name: "ALL"
          allowed_hosts_list: ["localhost","LOCAL"]

        xinetd:
          allowed_service_name: "xinetd"
          allowed_hosts_list:
            - ALL
            - hosts2

  tasks:
    - name: read hosts.allow file
      shell: "cat /etc/hosts.allow"
      changed_when: false
      register: read_config_file_result

    - debug:
        var: read_config_file_result.stdout

    - name: verify that hosts.allow matches inventory
      assert:
        that:
          - read_config_file_result.stdout | search ("{{ item.value.allowed_service_name }}")
          - read_config_file_result.stdout | search ("{{ item.value.allowed_hosts_list }}")
      with_dict: "{{ tcpwrappers_allow }}"

    - name: read hosts.deny file
      shell: "cat /etc/hosts.deny"
      changed_when: false
      register: read_config_file_result

    - name: verify that hosts.deny matches inventory
      assert:
        that:
          - read_config_file_result.stdout | search ("{{ item.value.denied_service_name }}")
          - read_config_file_result.stdout | search ("{{ item.value.denied_hosts_list }}")
      with_dict: "{{ tcpwrappers_deny }}"

  #tags:
  #  - idempotence
